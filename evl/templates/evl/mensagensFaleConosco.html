{% extends 'evl/base.html' %}
{% block content %}
<title>EVL - Dúvidas</title>

<body>
  {% include 'evl/imports.html' %}
  <div class="view hm-white-light jarallax marginTopHome bgFaleConosco"  style="background-size:cover!important;"  data-jarallax='{"speed": 0.2}'>
    <div class="full-bg-img">
      <div class="container flex-center">
        <div class="row" style="width: 90% !important;" id="tabs">
          <ul class="nav nav-tabs nav-tabs-padding">
            <li class="active nav-item nav-item-space"><a class="active" href="#tab1" data-toggle="tab" >Mensagens</a></li>
            <li class="nav-item nav-item-space"><a href="#tab2" data-toggle="tab" >Detalhes</a></li>
          </ul>
          <div class="col-md-12 wow fadeIn">
            <div class="text-center titleFontProperties">
              <div style="overflow: auto;" class="propriedades-tabela">
                <div class="tab-content tab-content-padding">
                  <div id="tab1">
                    <table class="table table-hover display" id="minhaTabela">
                      <thead>
                        <tr class="table-light">
                          <th scope="col">ID</th>
                          <th scope="col">Título</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for message in messages %}
                        <tr class="table-light">
                          <td>{{ message.id_conversa }}</td>
                          <td>{{ message.titulo }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  <div id="tab2">
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
  $(document).ready(function(){
    $('#minhaTabela tbody').on('click', 'tr', function(){
      var minhaTabela = $("#minhaTabela").DataTable();
      if ( $(this).hasClass('selected') ) {
        $(this).removeClass('selected');
      }
      else {
        minhaTabela.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
      }
      data = minhaTabela.row(this).data();

      $.ajax({
        type: "POST",
        dataType: 'json',
        url: "/faleConoscoMensagens/",
        data: {
          id: data[0],
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(data){
          mensagens = "";
          mensagens += '<div style="overflow-y:scroll; overflow-x:hidden; margin-top:50px; height:350px;">';
          for (var i = 0, len = data.length; i < len; i++) {
            var data_mensagem = data[i].data_mensagem.substring(8, 10) + '/' + data[i].data_mensagem.substring(5, 7) + '/' + data[i].data_mensagem.substring(0, 4);
            var hora_mensagem = data[i].data_mensagem.substring(11, 16)
            mensagens += '<div class="row">'
            if (data[i].aluno != false) {
              mensagens += '<div class="col-sm-11">'
              mensagens += '<div style="background:blue;"> ';
            }
            else {
              mensagens += '<div class="col-sm-11 pull-right">'
              mensagens += '<div style="background:red;"> ';
            }
            mensagens +=
            '  <div class="panel-heading">'+
            '      <h3 class="panel-title">' + data[i].cpf + '</h3>'+
            '  </div>'+
            '  <div class="panel-body" style="word-break: break-all;">'+
            data[i].texto_mensagem +
            '  </div><div class="text-right" style="font-style: italic; margin-right:10px;">'+
            data_mensagem + '  ' +
            hora_mensagem +
            '</div></div></div></div><hr>';
          };
          mensagens += '</div>';
          $('#tab2').html(mensagens);
          $('#tabs').tabs({ active: 1})
        },
        error: function(data){
          console.log("failure");
          console.log(data);
        },
      });
    });
  })
  </script>
  <script src="/static/js/jquery-3.3.1.js"></script>
  <script src="/static/js/dataTable.js"></script>
  <script type="text/javascript">
  $.noConflict();
  </script>
</body>
{% endblock %}
